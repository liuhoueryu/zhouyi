{% extends "zhouyi_app/base.html" %}
{% load math_extras %}
{% block title %}AIæ·±åº¦åˆ†æ - å‘¨æ˜“å åœç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
    .ai-analysis-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .ai-header {
        text-align: center;
        margin-bottom: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .ai-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        border-left: 5px solid #667eea;
    }
    
    .sentiment-analysis {
        border-left-color: #4CAF50;
    }
    
    .ai-interpretation {
        border-left-color: #FF9800;
    }
    
    .trend-prediction {
        border-left-color: #2196F3;
    }
    
    .similar-cases {
        border-left-color: #9C27B0;
    }
    
    .sentiment-badge {
        display: inline-block;
        padding: 8px 20px;
        border-radius: 25px;
        font-weight: bold;
        margin: 10px 5px;
        color: white;
        font-size: 16px;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
    }
    
    .sentiment-positive { 
        background: linear-gradient(135deg, #4CAF50, #45a049);
    }
    
    .sentiment-negative { 
        background: linear-gradient(135deg, #f44336, #da190b);
    }
    
    .sentiment-neutral { 
        background: linear-gradient(135deg, #FF9800, #e68900);
    }
    
    .confidence-meter {
        width: 100%;
        height: 20px;
        background: #f0f0f0;
        border-radius: 10px;
        margin: 15px 0;
        overflow: hidden;
    }
    
    .confidence-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 1s ease-in-out;
    }
    
    .confidence-high { background: linear-gradient(90deg, #4CAF50, #8BC34A); }
    .confidence-medium { background: linear-gradient(90deg, #FF9800, #FFC107); }
    .confidence-low { background: linear-gradient(90deg, #f44336, #FF5722); }
    
    .ai-interpretation-text {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border-left: 4px solid #FF9800;
        font-size: 16px;
        line-height: 1.6;
        margin: 15px 0;
    }
    
    .trend-indicator {
        display: inline-flex;
        align-items: center;
        padding: 10px 20px;
        border-radius: 25px;
        background: #e3f2fd;
        margin: 10px 5px;
        font-weight: bold;
        color: #1976D2;
    }
    
    .trend-rising {
        background: #e8f5e9;
        color: #2E7D32;
    }
    
    .trend-emerging {
        background: #fff3e0;
        color: #EF6C00;
    }
    
    .trend-stable {
        background: #f3e5f5;
        color: #7B1FA2;
    }
    
    .similar-case-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin: 10px 0;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
    }
    
    .similar-case-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #9C27B0;
    }
    
    .similarity-bar {
        height: 8px;
        background: #f0f0f0;
        border-radius: 4px;
        margin: 8px 0;
        overflow: hidden;
    }
    
    .similarity-fill {
        height: 100%;
        border-radius: 4px;
        background: linear-gradient(90deg, #9C27B0, #E91E63);
    }
    
    .stat-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        margin: 10px;
        flex: 1;
        min-width: 150px;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #667eea;
        margin: 10px 0;
    }
    
    .stat-label {
        color: #666;
        font-size: 14px;
    }
    
    .stats-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        margin: 20px 0;
    }
    
    .ai-loading {
        text-align: center;
        padding: 40px;
    }
    
    .pulse-dots {
        display: inline-block;
        margin: 20px 0;
    }
    
    .pulse-dots span {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #667eea;
        margin: 0 4px;
        animation: pulse 1.4s infinite ease-in-out;
    }
    
    .pulse-dots span:nth-child(1) { animation-delay: -0.32s; }
    .pulse-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes pulse {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }
    
    .section-title {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        color: #333;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
    }
    
    .section-title i {
        font-size: 24px;
        margin-right: 10px;
    }
    
    .tech-badge {
        display: inline-block;
        background: #e0e0e0;
        color: #666;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        margin: 0 5px;
    }
    
    .model-info {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        font-size: 14px;
        color: #666;
    }
    
    @media (max-width: 768px) {
        .ai-analysis-container {
            padding: 10px;
        }
        
        .stats-container {
            flex-direction: column;
        }
        
        .stat-card {
            margin: 5px 0;
        }
        
        .ai-header {
            padding: 20px 15px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="ai-analysis-container">
    <!-- AIåˆ†æå¤´éƒ¨ -->
    <div class="ai-header">
        <h1>ğŸ¤– AIæ·±åº¦åˆ†ææŠ¥å‘Š</h1>
        <p>åŸºäºæ·±åº¦å­¦ä¹ ç®—æ³•çš„ä¸ªæ€§åŒ–å¦è±¡è§£è¯»</p>
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value">{{ record.hexagram_name }}</div>
                <div class="stat-label">å¦è±¡åç§°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ record.created_time|date:"m/d" }}</div>
                <div class="stat-label">å åœæ—¥æœŸ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">
                    {% if record.sentiment_analysis.confidence %}
                        {{ record.sentiment_analysis.confidence|floatformat:2 }}
                    {% else %}
                        -
                    {% endif %}
                </div>
                <div class="stat-label">åˆ†æç½®ä¿¡åº¦</div>
            </div>
        </div>
    </div>

    <!-- æ£€æŸ¥AIåˆ†ææ˜¯å¦å®Œæˆ -->
    {% if not record.ai_interpretation %}
    <div class="ai-loading">
        <h3>ğŸ”® AIæ·±åº¦åˆ†æè¿›è¡Œä¸­</h3>
        <div class="pulse-dots">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <p>æ­£åœ¨è¿ç”¨æ·±åº¦å­¦ä¹ ç®—æ³•ä¸ºæ‚¨ç”Ÿæˆä¸ªæ€§åŒ–è§£è¯»...</p>
        <div class="model-info">
            <p><strong>åˆ†ææµç¨‹ï¼š</strong></p>
            <ol style="text-align: left; display: inline-block;">
                <li>æƒ…æ„Ÿåˆ†ææ¨¡å‹å¤„ç†æ‚¨çš„æŸ¥è¯¢</li>
                <li>è‡ªç„¶è¯­è¨€ç”Ÿæˆæ¨¡å‹åˆ›å»ºä¸ªæ€§åŒ–è§£è¯»</li>
                <li>ç›¸ä¼¼åº¦ç®—æ³•æŸ¥æ‰¾ç›¸å…³å†å²æ¡ˆä¾‹</li>
                <li>è¶‹åŠ¿é¢„æµ‹æ¨¡å‹åˆ†æå¦è±¡æ¨¡å¼</li>
            </ol>
        </div>
        <p>è¿™é€šå¸¸éœ€è¦å‡ ç§’é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...</p>
    </div>
    {% else %}

    <!-- æƒ…æ„Ÿåˆ†æéƒ¨åˆ† -->
    <div class="ai-section sentiment-analysis">
        <div class="section-title">
            <i>ğŸ˜Š</i>
            <h2>æƒ…æ„Ÿåˆ†æ</h2>
        </div>

        <p>AIåˆ†æäº†æ‚¨æŸ¥è¯¢äº‹é¡¹çš„æƒ…æ„Ÿå€¾å‘ï¼š</p>

        <div style="text-align: center; margin: 20px 0;">
            {% if record.sentiment_analysis.sentiment == "ç§¯æ" %}
            <div class="sentiment-badge sentiment-positive">
                ğŸ˜Š ç§¯æä¹è§‚
            </div>
            {% elif record.sentiment_analysis.sentiment == "æ¶ˆæ" %}
            <div class="sentiment-badge sentiment-negative">
                ğŸ˜” æ‹…å¿§ç„¦è™‘
            </div>
            {% else %}
            <div class="sentiment-badge sentiment-neutral">
                ğŸ˜ ä¸­æ€§å¹³é™
            </div>
            {% endif %}
        </div>

        <p><strong>ç½®ä¿¡åº¦ï¼š</strong> {{ record.sentiment_analysis.confidence|floatformat:2 }}</p>
        <div class="confidence-meter">
            <div class="confidence-fill
                {% if record.sentiment_analysis.confidence > 0.7 %}confidence-high
                {% elif record.sentiment_analysis.confidence > 0.4 %}confidence-medium
                {% else %}confidence-low{% endif %}"
                style="width: {{ record.sentiment_analysis.confidence|floatformat:2|mul:100 }}%">
            </div>
        </div>

        <div class="model-info">
            <p><strong>æŠ€æœ¯è¯´æ˜ï¼š</strong> ä½¿ç”¨åŸºäºTransformerçš„æƒ…æ„Ÿåˆ†ææ¨¡å‹ï¼Œåˆ†ææ‚¨æŸ¥è¯¢æ–‡æœ¬çš„æƒ…æ„Ÿå€¾å‘ã€‚</p>
            <span class="tech-badge">BERTæ¶æ„</span>
            <span class="tech-badge">ä¸­æ–‡æƒ…æ„Ÿåˆ†æ</span>
            <span class="tech-badge">æ·±åº¦å­¦ä¹ </span>
        </div>
    </div>

    <!-- AIä¸ªæ€§åŒ–è§£è¯» -->
    <div class="ai-section ai-interpretation">
        <div class="section-title">
            <i>ğŸ’¡</i>
            <h2>AIä¸ªæ€§åŒ–è§£è¯»</h2>
        </div>

        <p>åŸºäºæ‚¨çš„æƒ…æ„ŸçŠ¶æ€å’Œå¦è±¡ç‰¹å¾ï¼ŒAIç”Ÿæˆäº†ä»¥ä¸‹ä¸ªæ€§åŒ–è§£è¯»ï¼š</p>

        <div class="ai-interpretation-text">
            {{ record.ai_interpretation }}
        </div>

        <div class="model-info">
            <p><strong>æŠ€æœ¯è¯´æ˜ï¼š</strong> ä½¿ç”¨GPTç³»åˆ—æ¨¡å‹ï¼Œç»“åˆæ‚¨çš„æƒ…æ„Ÿåˆ†æå’Œå¦è±¡ç‰¹å¾ï¼Œç”Ÿæˆä¸ªæ€§åŒ–çš„æ™ºæ…§å»ºè®®ã€‚</p>
            <span class="tech-badge">GPTæ¨¡å‹</span>
            <span class="tech-badge">è‡ªç„¶è¯­è¨€ç”Ÿæˆ</span>
            <span class="tech-badge">ä¸Šä¸‹æ–‡ç†è§£</span>
        </div>
    </div>

    <!-- è¶‹åŠ¿é¢„æµ‹ -->
    <div class="ai-section trend-prediction">
        <div class="section-title">
            <i>ğŸ“ˆ</i>
            <h2>è¶‹åŠ¿é¢„æµ‹åˆ†æ</h2>
        </div>

        <p>åŸºäºå†å²æ•°æ®ï¼ŒAIåˆ†æäº†æ­¤å¦è±¡çš„å‡ºç°æ¨¡å¼å’Œè¶‹åŠ¿ï¼š</p>

        <div style="text-align: center; margin: 20px 0;">
            {% if record.trend_prediction.trend == "rising" %}
            <div class="trend-indicator trend-rising">
                ğŸ“ˆ å¸¸è§å¦è±¡
            </div>
            {% elif record.trend_prediction.trend == "emerging" %}
            <div class="trend-indicator trend-emerging">
                ğŸŒŸ æ–°å…´å¦è±¡
            </div>
            {% else %}
            <div class="trend-indicator trend-stable">
                âš–ï¸ ç¨³å®šå¦è±¡
            </div>
            {% endif %}
        </div>

        <div style="margin: 15px 0;">
            <p><strong>å†å²å‡ºç°æ¦‚ç‡ï¼š</strong> {{ record.trend_prediction.probability|floatformat:3 }}</p>
            <p><strong>åˆ†æç½®ä¿¡åº¦ï¼š</strong> {{ record.trend_prediction.confidence|floatformat:2 }}</p>
            <p><strong>åŸºäºæ•°æ®é‡ï¼š</strong> {{ record.trend_prediction.total_cases }} ä¸ªå†å²æ¡ˆä¾‹</p>
        </div>

        <div class="model-info">
            <p><strong>æŠ€æœ¯è¯´æ˜ï¼š</strong> ä½¿ç”¨ç»Ÿè®¡åˆ†æå’Œæ¨¡å¼è¯†åˆ«ç®—æ³•ï¼ŒåŸºäºå†å²å åœæ•°æ®é¢„æµ‹å¦è±¡è¶‹åŠ¿ã€‚</p>
            <span class="tech-badge">ç»Ÿè®¡åˆ†æ</span>
            <span class="tech-badge">æ¨¡å¼è¯†åˆ«</span>
            <span class="tech-badge">æ¦‚ç‡é¢„æµ‹</span>
        </div>
    </div>

    <!-- ç›¸ä¼¼æ¡ˆä¾‹ -->
    <div class="ai-section similar-cases">
        <div class="section-title">
            <i>ğŸ”</i>
            <h2>ç›¸ä¼¼å†å²æ¡ˆä¾‹</h2>
        </div>

        <p>AIæ‰¾åˆ°äº†ä¸æ‚¨æŸ¥è¯¢ç›¸ä¼¼çš„å†å²å åœæ¡ˆä¾‹ï¼š</p>

        {% if record.similar_cases %}
            {% for case in record.similar_cases %}
            <div class="similar-case-card">
                <a href="/detail/{{ case.id }}/" style="text-decoration: none; color: inherit;">
                    <h4>{{ case.thing }}</h4>
                    <p><strong>å¦è±¡ï¼š</strong> {{ case.hexagram_name }}</p>
                    <p><strong>æ—¶é—´ï¼š</strong> {{ case.time|slice:":10" }}</p>
                    <p><strong>ç›¸ä¼¼åº¦ï¼š</strong> {{ case.similarity|floatformat:2 }}</p>
                    <div class="similarity-bar">
                        <div class="similarity-fill" style="width: {{ case.similarity|floatformat:2|mul:100 }}%"></div>
                    </div>
                </a>
            </div>
            {% endfor %}
        {% else %}
            <p style="text-align: center; padding: 20px; color: #666;">
                æš‚æ— é«˜åº¦ç›¸ä¼¼çš„å†å²æ¡ˆä¾‹
            </p>
        {% endif %}

        <div class="model-info">
            <p><strong>æŠ€æœ¯è¯´æ˜ï¼š</strong> ä½¿ç”¨TF-IDFå‘é‡åŒ–å’Œä½™å¼¦ç›¸ä¼¼åº¦ç®—æ³•ï¼Œåœ¨å†å²æ•°æ®ä¸­æŸ¥æ‰¾è¯­ä¹‰ç›¸ä¼¼çš„å åœæ¡ˆä¾‹ã€‚</p>
            <span class="tech-badge">TF-IDF</span>
            <span class="tech-badge">ä½™å¼¦ç›¸ä¼¼åº¦</span>
            <span class="tech-badge">è¯­ä¹‰åˆ†æ</span>
        </div>
    </div>

    <!-- AIæ¨¡å‹ä¿¡æ¯ -->
    <div class="ai-section">
        <div class="section-title">
            <i>ğŸ”§</i>
            <h2>AIæŠ€æœ¯æ¶æ„</h2>
        </div>

        <p>æœ¬åˆ†æç³»ç»Ÿä½¿ç”¨äº†å¤šç§å…ˆè¿›çš„æ·±åº¦å­¦ä¹ æŠ€æœ¯ï¼š</p>

        <div style="display: flex; flex-wrap: wrap; justify-content: center; margin: 20px 0;">
            <div class="stat-card">
                <div class="stat-value">3+</div>
                <div class="stat-label">AIæ¨¡å‹</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">æ·±åº¦å­¦ä¹ </div>
                <div class="stat-label">æ ¸å¿ƒæŠ€æœ¯</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">å®æ—¶</div>
                <div class="stat-label">åˆ†æé€Ÿåº¦</div>
            </div>
        </div>

        <div class="model-info">
            <h4>ä½¿ç”¨çš„æ¨¡å‹å’ŒæŠ€æœ¯ï¼š</h4>
            <ul>
                <li><strong>æƒ…æ„Ÿåˆ†æï¼š</strong> åŸºäºTransformerçš„ä¸­æ–‡æƒ…æ„Ÿåˆ†ç±»æ¨¡å‹</li>
                <li><strong>æ–‡æœ¬ç”Ÿæˆï¼š</strong> GPTç³»åˆ—ä¸­æ–‡è¯­è¨€æ¨¡å‹</li>
                <li><strong>ç›¸ä¼¼åº¦è®¡ç®—ï¼š</strong> TF-IDF + ä½™å¼¦ç›¸ä¼¼åº¦ç®—æ³•</li>
                <li><strong>è¶‹åŠ¿é¢„æµ‹ï¼š</strong> ç»Ÿè®¡åˆ†æ + æ¨¡å¼è¯†åˆ«</li>
            </ul>
        </div>
    </div>

    <!-- æ³¨æ„äº‹é¡¹ -->
    <div class="warning-box" style="margin-top: 30px;">
        <h4>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h4>
        <p>AIåˆ†æç»“æœåŸºäºç®—æ³•æ¨¡å‹ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒã€‚çœŸæ­£çš„æ™ºæ…§æ¥è‡ªäºå†…å¿ƒçš„æ€è€ƒå’Œç°å®çš„å®è·µã€‚</p>
        <p>ã€Šå‘¨æ˜“ã€‹æœ‰äº‘ï¼š"è§‚ä¹å¤©æ–‡ï¼Œä»¥å¯Ÿæ—¶å˜ï¼›è§‚ä¹äººæ–‡ï¼Œä»¥åŒ–æˆå¤©ä¸‹ã€‚" æ„¿AIåˆ†æèƒ½ä¸ºæ‚¨æä¾›æ–°çš„è§†è§’ï¼Œä½†æœ€ç»ˆå†³ç­–ä»éœ€ä¾é æ‚¨è‡ªå·±çš„æ™ºæ…§ã€‚</p>
    </div>

    {% endif %}

    <!-- æ“ä½œæŒ‰é’® -->

</div>
{% endblock %}

{% block extra_js %}
<script>
    // å¦‚æœAIåˆ†æå°šæœªå®Œæˆï¼Œå®šæœŸæ£€æŸ¥æ›´æ–°
    {% if not record.ai_interpretation %}
    function checkAiAnalysis() {
        fetch("/detail/{{ record.id }}/")
            .then(response => response.json())
            .then(data => {
                if (data.has_analysis) {
                    // é‡æ–°åŠ è½½é¡µé¢ä»¥æ˜¾ç¤ºAIåˆ†æ
                    location.reload();
                } else {
                    // 5ç§’åå†æ¬¡æ£€æŸ¥
                    setTimeout(checkAiAnalysis, 5000);
                }
            })
            .catch(error => {
                console.error('æ£€æŸ¥AIåˆ†æå¤±è´¥:', error);
                setTimeout(checkAiAnalysis, 10000);
            });
    }

    // é¡µé¢åŠ è½½åå¼€å§‹æ£€æŸ¥
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(checkAiAnalysis, 3000);
    });
    {% else %}
    // å¦‚æœAIåˆ†æå·²å®Œæˆï¼Œæ·»åŠ ä¸€äº›äº¤äº’åŠ¨ç”»
    document.addEventListener('DOMContentLoaded', function() {
        // æ¸å…¥åŠ¨ç”»
        const sections = document.querySelectorAll('.ai-section');
        sections.forEach((section, index) => {
            section.style.opacity = '0';
            section.style.transform = 'translateY(20px)';

            setTimeout(() => {
                section.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                section.style.opacity = '1';
                section.style.transform = 'translateY(0)';
            }, index * 200);
        });

        // è¿›åº¦æ¡åŠ¨ç”»
        const confidenceFill = document.querySelector('.confidence-fill');
        if (confidenceFill) {
            const width = confidenceFill.style.width;
            confidenceFill.style.width = '0';
            setTimeout(() => {
                confidenceFill.style.width = width;
            }, 500);
        }

        // ç›¸ä¼¼åº¦æ¡åŠ¨ç”»
        const similarityFills = document.querySelectorAll('.similarity-fill');
        similarityFills.forEach((fill, index) => {
            const width = fill.style.width;
            fill.style.width = '0';
            setTimeout(() => {
                fill.style.width = width;
            }, 800 + index * 200);
        });
    });
    {% endif %}
</script>
{% endblock %}