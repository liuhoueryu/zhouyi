{% extends "zhouyi_app/base.html" %}

{% block title %}å åœè¿›è¡Œä¸­ - å‘¨æ˜“å åœç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
    .loading-container {
        text-align: center;
        padding: 40px 20px;
    }

    .animation-area {
        height: 200px;
        position: relative;
        margin: 30px 0;
    }

    .incense-stick {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 8px;
        height: 120px;
        background: linear-gradient(to top, #8B4513 0%, #D2691E 100%);
        border-radius: 4px;
    }

    .smoke {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 4px;
        height: 0;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        animation: smokeRise 3s infinite;
    }

    .coin {
        width: 40px;
        height: 40px;
        background: linear-gradient(45deg, #FFD700, #D4AF37);
        border-radius: 50%;
        display: inline-block;
        margin: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        position: relative;
        animation: coinFlip 2s infinite;
    }

    .coin:nth-child(2) {
        animation-delay: 0.3s;
    }

    .coin:nth-child(3) {
        animation-delay: 0.6s;
    }

    .hexagram-building {
        font-size: 36px;
        line-height: 1.8;
        margin: 20px 0;
        min-height: 220px;
    }

    .hexagram-line {
        opacity: 0;
        animation: fadeIn 0.5s forwards;
    }

    .progress-container {
        width: 100%;
        background: #f0f0f0;
        border-radius: 10px;
        margin: 20px 0;
        height: 20px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #8B4513, #D2691E);
        border-radius: 10px;
        width: 0%;
        transition: width 0.5s ease;
    }

    .step-info {
        margin: 20px 0;
        font-size: 18px;
        color: #8B4513;
        min-height: 60px;
    }

    .phase-title {
        font-size: 24px;
        color: #8B4513;
        margin: 30px 0 20px;
        border-bottom: 2px solid #8B4513;
        padding-bottom: 10px;
        display: inline-block;
    }

    @keyframes smokeRise {
        0% {
            height: 0;
            opacity: 0;
            transform: translateX(-50%) translateY(0);
        }
        50% {
            height: 80px;
            opacity: 0.7;
            transform: translateX(-50%) translateY(-40px);
        }
        100% {
            height: 120px;
            opacity: 0;
            transform: translateX(-50%) translateY(-80px);
        }
    }

    @keyframes coinFlip {
        0%, 100% {
            transform: rotateY(0deg);
        }
        50% {
            transform: rotateY(180deg);
        }
    }

    @keyframes fadeIn {
        to {
            opacity: 1;
        }
    }

    .hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="loading-container">
    <h2>ğŸ‹ å åœè¿›è¡Œä¸­ ğŸ‹</h2>

    <div class="info-box">
        <p><strong>å åœäº‹é¡¹ï¼š</strong>{{ thing }}</p>
        <p>è¯·ä¿æŒå¿ƒè¯šï¼Œé™å¾…å¦è±¡æ˜¾ç°...</p>
    </div>

    <!-- ç„šé¦™é˜¶æ®µ -->
    <div id="incense-phase">
        <h3 class="phase-title">ç¬¬ä¸€æ­¥ï¼šç„šé¦™ç¥ˆç¦</h3>
        <div class="animation-area">
            <div class="incense-stick"></div>
            <div class="smoke"></div>
            <div class="smoke" style="left: calc(50% - 15px); animation-delay: 0.5s;"></div>
            <div class="smoke" style="left: calc(50% + 15px); animation-delay: 1s;"></div>
        </div>
        <div class="step-info" id="incense-step">å‡†å¤‡å¼€å§‹ç„šé¦™...</div>
    </div>

    <!-- æ·å¸é˜¶æ®µ -->
    <div id="coin-phase" class="hidden">
        <h3 class="phase-title">ç¬¬äºŒæ­¥ï¼šæ·å¸èµ·å¦</h3>
        <div class="animation-area">
            <div class="coin"></div>
            <div class="coin"></div>
            <div class="coin"></div>
        </div>
        <div class="step-info" id="coin-step">å‡†å¤‡å¼€å§‹æ·å¸...</div>
    </div>

    <!-- å¦è±¡ç”Ÿæˆé˜¶æ®µ -->
    <div id="hexagram-phase" class="hidden">
        <h3 class="phase-title">ç¬¬ä¸‰æ­¥ï¼šå¦è±¡ç”Ÿæˆ</h3>
        <div class="hexagram-building" id="hexagram-display">
            <!-- å¦è±¡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="step-info" id="hexagram-step">æ­£åœ¨ç”Ÿæˆå¦è±¡...</div>
    </div>

    <!-- è¿›åº¦æ¡ -->
    <div class="progress-container">
        <div class="progress-bar" id="overall-progress"></div>
    </div>
    <div id="progress-text">æ€»ä½“è¿›åº¦: 0%</div>

    <!-- å®Œæˆæç¤º -->
    <div id="completion-message" class="hidden">
        <div class="success" style="margin: 30px 0;">
            <h3>âœ¨ å åœå®Œæˆ âœ¨</h3>
            <p>å¦è±¡å·²ç”Ÿæˆï¼Œæ­£åœ¨è·³è½¬åˆ°ç»“æœé¡µé¢...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const incensePhase = document.getElementById('incense-phase');
        const coinPhase = document.getElementById('coin-phase');
        const hexagramPhase = document.getElementById('hexagram-phase');
        const completionMessage = document.getElementById('completion-message');

        const incenseStep = document.getElementById('incense-step');
        const coinStep = document.getElementById('coin-step');
        const hexagramStep = document.getElementById('hexagram-step');
        const hexagramDisplay = document.getElementById('hexagram-display');

        const overallProgress = document.getElementById('overall-progress');
        const progressText = document.getElementById('progress-text');

        let currentProgress = 0;
        let currentPhase = 'incense';

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress(progress) {
            currentProgress = progress;
            overallProgress.style.width = progress + '%';
            progressText.textContent = 'æ€»ä½“è¿›åº¦: ' + progress + '%';
        }

        // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µ
        function nextPhase() {
            if (currentPhase === 'incense') {
                incensePhase.classList.add('hidden');
                coinPhase.classList.remove('hidden');
                currentPhase = 'coin';
                startCoinPhase();
            } else if (currentPhase === 'coin') {
                coinPhase.classList.add('hidden');
                hexagramPhase.classList.remove('hidden');
                currentPhase = 'hexagram';
                startHexagramPhase();
            } else if (currentPhase === 'hexagram') {
                // æ‰€æœ‰é˜¶æ®µå®Œæˆ
                completionMessage.classList.remove('hidden');
                // è·å–æœ€ç»ˆç»“æœ
                getFinalResult();
            }
        }

        // ç„šé¦™é˜¶æ®µ
        function startIncensePhase() {
            let incenseProgress = 0;
            const incenseInterval = setInterval(() => {
                fetch("/incense_burning/", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        incenseStep.textContent = data.step;
                        incenseProgress = data.progress;

                        // æ›´æ–°æ€»ä½“è¿›åº¦ï¼ˆç„šé¦™é˜¶æ®µå 30%ï¼‰
                        updateProgress(Math.floor(incenseProgress * 0.3));

                        if (incenseProgress >= 100) {
                            clearInterval(incenseInterval);
                            setTimeout(nextPhase, 1000);
                        }
                    }
                })
                .catch(error => {
                    console.error('ç„šé¦™è¯·æ±‚å¤±è´¥:', error);
                });
            }, 1200);
        }

        // æ·å¸é˜¶æ®µ
        function startCoinPhase() {
            let coinProgress = 0;
            const coinInterval = setInterval(() => {
                fetch("/throwing_coins/", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        coinStep.textContent = data.step;
                        coinProgress = data.progress;

                        // æ›´æ–°æ€»ä½“è¿›åº¦ï¼ˆæ·å¸é˜¶æ®µå 40%ï¼ŒåŠ ä¸Šç„šé¦™çš„30%ï¼‰
                        updateProgress(30 + Math.floor(coinProgress * 0.4));

                        if (coinProgress >= 100) {
                            clearInterval(coinInterval);
                            setTimeout(nextPhase, 1000);
                        }
                    }
                })
                .catch(error => {
                    console.error('æ·å¸è¯·æ±‚å¤±è´¥:', error);
                });
            }, 1000);
        }

        // å¦è±¡ç”Ÿæˆé˜¶æ®µ
        function startHexagramPhase() {
            const hexagramLines = [];
            let lineIndex = 0;

            const hexagramInterval = setInterval(() => {
                if (lineIndex < 6) {
                    // æ¨¡æ‹Ÿç”Ÿæˆæ¯ä¸€çˆ»
                    const lineTypes = ["â€”", "- -", "â€”   x", "- -   x"];
                    const randomLine = lineTypes[Math.floor(Math.random() * lineTypes.length)];
                    hexagramLines.push(randomLine);

                    // æ˜¾ç¤ºç”Ÿæˆçš„çˆ»
                    const lineElement = document.createElement('div');
                    lineElement.className = 'hexagram-line';
                    lineElement.textContent = randomLine;
                    lineElement.style.animationDelay = (lineIndex * 0.3) + 's';
                    hexagramDisplay.appendChild(lineElement);

                    hexagramStep.textContent = `æ­£åœ¨ç”Ÿæˆç¬¬ ${6 - lineIndex} çˆ»...`;
                    lineIndex++;

                    // æ›´æ–°æ€»ä½“è¿›åº¦ï¼ˆå¦è±¡ç”Ÿæˆé˜¶æ®µå 30%ï¼ŒåŠ ä¸Šå‰é¢çš„70%ï¼‰
                    updateProgress(70 + Math.floor((lineIndex / 6) * 30));
                } else {
                    clearInterval(hexagramInterval);
                    hexagramStep.textContent = "å¦è±¡ç”Ÿæˆå®Œæˆï¼";
                    setTimeout(nextPhase, 1500);
                }
            }, 800);
        }

        // è·å–æœ€ç»ˆç»“æœå¹¶è·³è½¬
        function getFinalResult() {
            fetch("/get_fortune_result/", {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // è·³è½¬åˆ°ç»“æœé¡µé¢
                    setTimeout(() => {
                        window.location.href = "/detail/" + data.record_id + "/";
                    }, 2000);
                } else {
                    alert('è·å–å¦è±¡ç»“æœå¤±è´¥ï¼Œè¯·é‡è¯•');
                    window.location.href = "/index/";
                }
            })
            .catch(error => {
                console.error('è·å–ç»“æœå¤±è´¥:', error);
                alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
                window.location.href = "/index/";
            });
        }
        
        // è·å–CSRF token
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // å¼€å§‹åŠ¨ç”»æµç¨‹
        setTimeout(startIncensePhase, 1000);
    });
</script>
{% endblock %}