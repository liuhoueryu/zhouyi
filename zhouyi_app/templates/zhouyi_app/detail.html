{% extends "zhouyi_app/base.html" %}

{% block title %}å åœè¯¦æƒ… - å‘¨æ˜“å åœç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
    .ai-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #e7077a;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
    }

    .sentiment-badge {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
        margin: 5px;
    }

    .sentiment-positive { background: #4CAF50; }
    .sentiment-negative { background: #f44336; }
    .sentiment-neutral { background: #FF9800; }

    .ai-interpretation {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 15px;
        margin: 15px 0;
        border-radius: 0 8px 8px 0;
    }

    .similar-case {
        background: white;
        border-radius: 8px;
        padding: 10px;
        margin: 8px 0;
        border-left: 3px solid #764ba2;
    }

    .trend-indicator {
        display: inline-block;
        padding: 8px 16px;
        border-radius: 20px;
        background: rgba(255,255,255,0.2);
        margin: 5px;
    }

    .loading-ai {
        text-align: center;
        padding: 20px;
    }

    .pulse-dots {
        display: inline-block;
    }

    .pulse-dots span {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #667eea;
        margin: 0 2px;
        animation: pulse 1.4s infinite ease-in-out;
    }

    .pulse-dots span:nth-child(1) { animation-delay: -0.32s; }
    .pulse-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes pulse {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block content %}
<div style="text-align: center;">
    <h2>å åœè¯¦æƒ…</h2>

    <div class="info-box">
        <p><strong>å åœäº‹é¡¹ï¼š</strong>{{ record.thing }}</p>
        <p><strong>å¦è±¡åç§°ï¼š</strong>{{ record.hexagram_name }}</p>
        <p><strong>å åœæ—¶é—´ï¼š</strong>{{ record.created_time|date:"Yå¹´mæœˆdæ—¥ Hæ—¶iåˆ†" }}</p>
        {% if record.ip_address %}
        <p><small>IPåœ°å€ï¼š{{ record.ip_address }}</small></p>
        {% endif %}
    </div>

    <div class="hexagram">
        <h3>å¦è±¡æ˜¾ç¤º</h3>
        {% for line in hexagram_lines %}
            <div>{{ line }}</div>
        {% endfor %}
    </div>

    {% if changing_lines %}
    <div class="warning-box">
        <p><strong>â€» å˜çˆ»ä½ç½®ï¼š</strong>
            {% for line in changing_lines %}
                ç¬¬{{ line|add:1 }}çˆ»{% if not forloop.last %}ã€{% endif %}
            {% endfor %}
        </p>
    </div>
    {% endif %}

    <!-- AIåˆ†æéƒ¨åˆ† -->
    <div id="ai-analysis-section">
        {% if has_ai_analysis %}
            {% include 'zhouyi_app/ai_analysis.html' %}

        {% else %}
            <div class="loading-ai">
                <h4>ğŸ¤– AIæ·±åº¦åˆ†æä¸­</h4>
                <div class="pulse-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <p>æ­£åœ¨è¿ç”¨æ·±åº¦å­¦ä¹ ç®—æ³•ä¸ºæ‚¨ç”Ÿæˆä¸ªæ€§åŒ–è§£è¯»...</p>
            </div>
        {% endif %}
    </div>

    <div style="margin: 30px 0;">
        <a href="{{ record.result_url }}" target="_blank" class="btn">æŸ¥çœ‹ä¼ ç»Ÿå¦è§£</a>
        <a href="/history/" class="btn btn-secondary">è¿”å›å†å²</a>
        <a href="/ai-insights/" class="btn">AIæ´å¯Ÿ</a>
        <a href="/index/" class="btn btn-secondary">è¿”å›é¦–é¡µ</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // å¦‚æœAIåˆ†æå°šæœªå®Œæˆï¼Œå®šæœŸæ£€æŸ¥æ›´æ–°
    {% if not has_ai_analysis %}
    function checkAiAnalysis() {
        fetch("/detail/{{ record.id }}/")
            .then(response => response.json())
            .then(data => {
                if (data.has_analysis) {
                    // é‡æ–°åŠ è½½é¡µé¢ä»¥æ˜¾ç¤ºAIåˆ†æ
                    location.reload();
                } else {
                    // 5ç§’åå†æ¬¡æ£€æŸ¥
                    setTimeout(checkAiAnalysis, 5000);
                }
            })
            .catch(error => {
                console.error('æ£€æŸ¥AIåˆ†æå¤±è´¥:', error);
                setTimeout(checkAiAnalysis, 10000);
            });
    }

    // é¡µé¢åŠ è½½åå¼€å§‹æ£€æŸ¥
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(checkAiAnalysis, 3000);
    });
    {% endif %}
</script>
{% endblock %}